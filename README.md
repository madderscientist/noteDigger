<div align="center">
  <a href="https://madderscientist.github.io/noteDigger/" target="_blank">
    <img width="240" src="./img/logo.png" alt="logo"><br>
    <img width="260" src="./img/logo_text.png" alt="noteDigger"><br>
  </a>
  ~前端辅助人工扒谱工具~
</div>

# noteDigger!
“Note Digger”——音符挖掘者，即扒谱。模仿的是软件wavetone，但是是双击即用、现代UI的前端应用。<br>
推进ing……目标是全部自己造轮子！即：不使用框架、不使用外部库；目的是减小项目大小，并掌握各个环节。目前频谱分析的软件非常多，功能也超级强大，自知比不过……所以唯一能一战的就是项目体积了！作为一个纯前端项目，就要把易用的优点完全发扬！<br>
[在线使用](https://madderscientist.github.io/noteDigger/)

## 使用流程
1. 在线or下载到本地，用主流现代浏览器打开(开发使用Chrome)。
2. 导入音频——文件-上传，或直接将音频拖拽进去！
3. 选择声道分析，或者导入之前分析的结果(只有选择音频之后才有导入之前结果的接口)
4. 根据频谱分析，开始绘制midi音符！调整音量，反复比对。
5. 导出为midi等，或者暂时导出项目(下次继续)

## 导入导出说明
- 导出进度: 结果是.nd的二进制文件，保存分析结果(频谱图)和音符音轨。导入的时候并不会强制要求匹配原曲！(会根据文件名判断一下，但不强制)
- 导出为midi: 只保证能听，节拍默认4/4，bpm默认60，midi类型默认1(同步多音轨)。第10轨不会分配为鼓点轨(本项目设计并不考虑扒鼓)。
- 导入midi: 将midi音符导入，只保证音轨、音符、音色能对应，音量默认127。如果导入后没有超过总音轨数，会在后面增加；否则会覆盖后面几轨(有提示)。

## 常规操作
- 空格: 播放
- 双击时间轴: 从双击的位置开始播放
- 在时间轴上拖拽: 设置重复区间
- 鼠标中键时间轴：将时间设置到点击位置，播放状态保持上一刻
- 按住空白拖动: 在当前音轨绘制一个音符
- 按住音符左半边拖动: 改变位置
- 按住音符右半边拖动: 改变时长
- Ctrl+点击音符: 多选音符
- delete: 删除选中的音符
- Ctrl+滚轮: 横向缩放
- 按住中键拖拽、触摸板滑动: 移动视野
- ←↑→↓: 视野移动一格

## 快捷键
只有在导入并分析音频之后才能使用这些快捷键
- Ctrl+Z: 撤销(音轨状态的改变不会引发存档，且只记录16次历史)
- Ctrl+Y: 重做
- Ctrl+A: 全选当前音轨
- Ctrl+Shift+A: 全选所有音轨
- Ctrl+D: 取消选中
- Ctrl+C: 复制选中的音符
- Ctrl+X: 剪贴选中的音符
- Ctrl+V: 粘贴到选中的音轨上（暂不实现跨页面粘贴）
- Ctrl+B: 呼出/收回音轨面板
- Shift+右键: 菜单，包含撤销/重做、复制/粘贴、删除

## 小细节
- 滑动条，如果旁边有数字，点击就可以恢复初始值。
- 多次点击“笔”右侧的选择工具，可以切换选择模式。（注意，只能选中当前音轨的音符）
- 点击某个音符可以选中该轨。

## 文件结构
```
│  app.js: 最重要的文件，主程序
│  channelDiv.js: 多音轨的UI界面类, 可拖拽列表
│  contextMenu.js: 右键菜单类
│  favicon.ico: 小图标
│  index.html: 程序入口, 其js主要是按钮的onclick
│  LICENSE
│  midi.js: midi创建、解析类
│  myRange.js: 横向滑动条的封装类
│  README.md
│  saver.js: 二进制保存相关
│  siderMenu.js: 侧边栏菜单类
│  snapshot.js: 快照类, 实现撤销和重做
│  tinySynth.js: 合成器类, 负责播放音频
│  todo.md: 一些设计思路和权衡
│
├─dataProcess
│      analyser.js: 频域数据分析与简化
│      fft_real.js: 执行实数FFT获取频域数据
│
├─img
│      github-mark-white.png
│      logo-small.png
│      logo.png
│      logo_text.png
│
└─style
    │  askUI.css: 达到类似<dialog>效果
    │  channelDiv.css: 多音轨UI样式
    │  contextMenu.css: 右键菜单样式
    │  myRange.css: 包装滑动条
    │  siderMenu.css: 侧边菜单样式
    │  style.css: index中独立元素的样式
    │
    └─icon: 从阿里图标库得到的icon
            iconfont.css
            iconfont.ttf
            iconfont.woff
            iconfont.woff2
```

## bug to fix
当前绘制为了加速使用二分法，排序依据是开始时间，没有考虑音符的长度，因此导致先开始但时长超长的音符在开头在视野外时不绘制。

## 重要更新记录
### 2024 2 9
在今年完成了所有基本功能！本次更新了设置相关，简单地设计了调性分析的算法，已经完全可以用了！

### 2024 2 8
文件系统已经完善！已经可以随心所欲导入导出保存啦！同时修复了一些小bug、完善了一些api。<br>
界面上，本打算将文件相关选项放到logo上，但是侧边菜单似乎有些空了，于是就加入到侧边栏，而logo设置为刷新或开新界面（考察了其他网站的logo的用途）。同时给侧边菜单加入了“设置”和“分析”，但本次更新没做。<br>
midi相关操作来自[我的另一个项目](https://github.com/madderscientist/je_score_operator)的midi类。将用midi转的wav导入分析，再导入原midi，两者同步播放的感觉真好！

### 2024 2 5
已经能用于扒谱了！完成了midi和原曲的播放与同步，填补了扒谱过程最重要的一环。<br>
UI基本完成！将侧边栏、滑动条封装成了js类。在此基础上，设计了类似VScode的菜单，用于存放不常用的功能和界面；而顶部窄窄一条用于放置常用功能。<br>
此外，完成了logo的设计。在2月4日的commit记录中(因为现在已经删除)可以看到设计的多种logo，最终选定了“在勺子里的音符”，这是一个被勺子dig出来的音符。其他思路可以概括为：“音符和铲子的组合”(logo2)、“埋在地里的音符”(logo5 logo6)、“像植物一样生长的八分音符”(logo8 logo10)、“音符和铲子结合”(logo12)。

### 2024 2 1
完成了多音轨、合成器和主线的整合，象征着midi系统的完成！<br>
统一了UI风格；完善了快捷键功能；新增框选功能；修复了大部分bug。

### 2024 1 30
完成了midi合成器tinySynth.js，实现了128种音色的播放。只有演奏音符的作用，控制器一点没做。<br>
原理是多个基础波形合成一个音色。波形参数来自 https://github.com/g200kg/webaudio-tinysynth ，因此程序设计也参考了它的设计。修改记录在todo.md中<br>
对于reference的解析（作者注释一点没写，变量命名极为简单，因此主要是变量解释）存放于“./tone/解析.md”(文件夹已被删除，请去历史提交查看)。文件夹中还有tinySynth的测试页面。在下一次push时将删除tone文件夹。<br>
这段时间内还完成了以下内容（全部记录在commit history的comments内）：
- 基本程序界面(三个画布：键盘、时频图、时间轴；UI界面：右键菜单、多音轨、滑动条)
- 基本逻辑功能：音符交互绘制、快捷键以及模块的关联协同

### 2023 12 13
从11月14日开始造js版fft轮子起，时隔一个月第一次提交项目，因为项目逻辑日渐复杂，需要能及时回退。主要完成了频谱绘制、钢琴键盘绘制、数据处理三部分，并初步确定了程序的结构框架。<br>
数据处理核心：实数FFT，编写于我《数字信号处理》刚刚学完FFT算法之时，针对本项目的应用场景做了专门的设计，即针对音频小波变换做了适配，具体表现为：实数加速、数据预计算、空间预分配、共用数组。<br>
由于整个项目还没搭建起来，因此不能测试NoteAnalyser类的数据处理效果。此类用于将频域数据进一步离散为音符强度数据。<br>
关于程序结构有一版废案，在文件夹"deprecated"中，设计思路是解耦、插件化，废弃理由是根本解耦不了。因此现在的代码耦合成一坨了。这个文件夹将在下一次push时被删除，存活于历史提交之中。<br>
tone文件夹将存放我的合成器轮子，audioplaytest是我音频播放的实验文件夹，todo.md是部分设计思路。

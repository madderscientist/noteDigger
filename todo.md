# 在线扒谱应用设计
1. 获取时域数据（Web Audio API 解码上传的音频文件）【done】
2. 获取频域信息（FFT类）【done】
采样率设置为44100，取8192点的实数FFT，分析范围：C1-B7，但点数限制只能区分F#2以上的音符。
3. 特征提取：提取84个音符的幅度。
粗糙地实现了。思路是只在需要的频率附近查找。
面临三个问题：
3.1. 频谱泄露如何处理
3.2. 最高到22050Hz，但是音符最高3950Hz，取到C8，即只需777点。后面的是否保留？
3.3. 有的音乐中心频率不是正好440Hz，是否需要自适应？和频谱泄露处理有关。
——目前的解决方案：在相邻音周围求平方和。因为有频谱泄露，所以需要收集泄露的频谱的能量。而频谱泄露是对称的，所以相邻音中间的频谱对半分。自适应不实现，因为上述解决方案对音不准有一定的适应能力（音乐高适应性越强，但低音容易出现误判）。每次处理以音符为单位，只搜索周围的能量，所以后面的没用到，随垃圾回收而释放。
4. 画图。交互
todo。面临问题：
4.1. 实时刷新还是一次画完？——选择实时刷新，用无限画布的思路
4.2. 幅度达到多少认为完全可信？——手调吧。设置一个参数。
功能：是否自动跟随？
5. 播放音乐和midi
todo。问题很多，主要是前端的midi播放。在后文列举。

## 边角功能：
文件拖拽上传。done
自动识别音符？比如利用频谱后面的内容，分辨出谐波

## 画图要点
无限画布 https://blog.csdn.net/shulianghan/article/details/120863626

## 键盘画图
C1对应24 全部按照midi协议编号。
以一个八度作为最小绘制单元，目前实现的绘图有所冗余，性能未达最优，但是懒得改了。

## midi可视化创建
关键是如何响应鼠标操作！用状态代替动作
描述一个midi音符：音高，起始，终止，是否选中

效果描述：
鼠标按下：
- 如果按在空白则新建音符，进入调整时长模式
- 如果按在音符上：
    ctrl是否按下？
    - 按下：选择多个
    - 没按下：是否已经选择了多个？
        - 是：鼠标抬起的时候，如果之前有拖动则什么也不做，否则仅选中当前那个
        - 否：仅选一个
        判断点击位置：
        - 前一半：后面的是拖动模式
        - 后一半：后面的是调整时长模式
        无论是那种模式，都支持音高上的调整

如何添加音符？
1. 点击的时候确认位置，已经添加进去了。
2. 设置这个音符为选中，模式是调整时长。

选中有两个方案：
1. 设置一个选中列表，存选中的midi音符对象的地址
有一个难点：绘制的时候如何让选中的不绘制两次？
2. 每个音符设置一个选中状态
有一个难点：每次调整音符状态的时候，都需要遍历所有音符

结论是：两者结合，空间换时间。

播放如何同步？

## 多音轨
此功能似乎用得不多。
wavetone中，每个音轨之间不存在明显的界限，而signal中，只有选中的音轨可以点击音符。
我觉得前者适合，可以加一个mute、visible选项控制音轨以达到signal中的效果
数据结构？
### midi音符的结构
两个方案：所有轨都在一个数组中，和每轨一个数组，或者……两者结合
- 所有轨都在一个数组：可以一次遍历实现音符拾取，绘制也只要一次遍历
- 每轨一个数组：可以方便地实现单轨样式的应用，更改音轨顺序容易
- 两者结合：维护较为麻烦
需要实现的功能：
- 撤销重做: 用一个数组合适
- 单音轨播放(静音、乐器)：其实也是一个数组简单，因为播放的时候只需要维护一次遍历
- 多音轨拖拽：音符拾取是单音轨简单。拖拽影响的是selected数组，两者平局
综上，存放音符还是单个数组合适。要实现以上功能，只需要给音符加一个channel属性，而每个音轨的设置需要维护一个数组。

### 音轨的结构
音轨的添加采用动态添加的方式还是静态？wavetone是静态，最大16。我做动态吧。
动态音轨涉及很多ui的东西：音轨的位置（设计为可拖拽排序）、属性设置
需要暴露的接口：
- 音轨变化事件(顺序、个数)：用于触发存档点，目前考虑封装成Event
- 音轨状态(颜色、当前选中)
- 序列化音轨、根据音轨参数数组创建音轨：用于实现音轨的快照
ChannelList的音轨列表及其属性似乎不需要暴露
下一步推进的关键：
MidiPlayer！需要成为ChannelList和ChannelItem的公共可访问对象，然后完成ui和数据的绑定。ChannelItem的instrument是否需要用序号代替？
耦合关系：
MidiAction监听ChannelList的事件，而ChannelList不监听MidiAction，但受其控制
- ChannelList->音轨变化(顺序、个数)->MidiAction&MidiPlayer
    如何传递这个变化？改变顺序用reorder事件，删除用remove事件，添加似乎不涉及midi音符的操作。【修正：新增channel也需要事件，用于存档】
    删除一个channel时，先触发remove，再触发reorder，remove事件用于删除midi列表对应通道的音符，reorder用于更改剩下的音符的音轨序号
    由于reorder只在序号发生变化时触发，如果是最后一个删除或添加就不会触发，这意味着对此事件监听不能响应所有变化，那如何设置存档点？存档单独注册一个reorder的监听，add/remove前先取消注册，由add/remove自行设置存档，操作结束再注册回来，防止两次存档。
- ChannelList->音轨音量改变->MidiPlayer
- ChannelList<-选中音符<-MidiAction

### 绘制
使用多音轨后，绘制逻辑需要改变
重叠：序号越低的音轨图层越上 & 选中的音轨置于顶层？——还是不要后者了。后者可以通过移动音轨实现
由于scroll相比刷新是稀疏的，可以维护一个“视野中的音符”列表insight，当scroll的时候更新其值。（有特例：批量移动音符的时候也需要更新）
为了实现小序号音轨在上层，insight是一个列表的列表，每个列表中是一个音轨的视野内的音符。绘制的时候，倒序遍历绘制，同时查询是否显示。

## 音符播放技术要点
参考 https://github.com/g200kg/webaudio-tinysynth 完成了精简版的合成器，相比原版，有如下变化：
- 抽象为类，音色变成static属性。
- 用animationFrame而非timeInterval实现了音符检查与停止。
- 为了契合“动态音轨”的设计，合成器中以channel为单位组织数组，而非原版以audioNode为单位。
- 每个音轨的原型都是合成器，故可以单独拿出来使用。
- 没有做成midi的形式，音符频率依赖外部传参
- 没有实现通道的调制、左右声道、混响。
- 没有做鼓的音色。